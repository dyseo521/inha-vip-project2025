AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: EECAR - B2B Platform for Used EV Parts Trading

Globals:
  Function:
    Runtime: nodejs20.x
    MemorySize: 512  # Cost-optimized, increase if needed
    Timeout: 30
    Tracing: Active  # X-Ray distributed tracing enabled
    Environment:
      Variables:
        PARTS_TABLE_NAME: !Ref PartsTable
        VECTORS_BUCKET_NAME: !Ref VectorsBucket
        DOCUMENTS_BUCKET_NAME: !Ref DocumentsBucket
        SNS_TOPIC_ARN: !Ref NotificationTopic
        BEDROCK_MODEL_ID: anthropic.claude-3-haiku-20240307-v1:0  # Cost-optimized for text generation (Titan is for embeddings)
        # RAG Enhancement: S3 Vectors + Bedrock Knowledge Base (Phase 2-3)
        USE_S3_VECTORS: 'true'  # Enabled after successful migration (79 vectors)
        USE_KNOWLEDGE_BASE: 'false'  # Set to 'true' after KB setup
        S3_VECTORS_BUCKET: 'eecar-vectors-index-12234628'  # Created in console
        S3_VECTORS_INDEX: 'parts-vectors'
        KNOWLEDGE_BASE_ID: ''  # Add KB ID after creation in console
  Api:
    Cors:
      AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
      AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key'"
      AllowOrigin: "'*'"

Resources:
  # Lambda Layer for shared utilities
  EECARUtilsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: eecar-utils-layer
      Description: Shared utilities for EECAR Lambda functions (DynamoDB, S3, Bedrock)
      ContentUri: ../backend/dist/layer/nodejs/
      CompatibleRuntimes:
        - nodejs20.x
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: nodejs20.x

  # API Gateway
  EECARApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Description: EECAR API Gateway
      TracingEnabled: true  # X-Ray distributed tracing enabled

  # Lambda Functions
  VectorSearchFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/dist/functions/vector-search/
      Handler: index.handler
      Description: AI-powered vector search with RAG enhancements (Query Expansion, Hybrid Search, Re-ranking)
      MemorySize: 1024  # Increased for advanced RAG processing
      Timeout: 60  # Longer timeout for multi-step RAG pipeline
      Layers:
        - !Ref EECARUtilsLayer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PartsTable
        - S3ReadPolicy:
            BucketName: !Ref VectorsBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: 'arn:aws:bedrock:ap-northeast-2::foundation-model/*'
            # S3 Vectors permissions (Phase 2)
            # ARN format: arn:aws:s3vectors:region:account:bucket/bucket-name/index/index-name
            - Effect: Allow
              Action:
                - s3vectors:QueryVectors
                - s3vectors:GetVectors
                - s3vectors:ListIndexes
                - s3vectors:GetIndex
              Resource:
                - 'arn:aws:s3vectors:ap-northeast-2:425454508084:bucket/eecar-vectors-index-12234628'
                - 'arn:aws:s3vectors:ap-northeast-2:425454508084:bucket/eecar-vectors-index-12234628/index/parts-vectors'
            # Bedrock Knowledge Base permissions (Phase 3)
            - Effect: Allow
              Action:
                - bedrock:Retrieve
                - bedrock:RetrieveAndGenerate
              Resource: !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/*'
      Events:
        Search:
          Type: Api
          Properties:
            RestApiId: !Ref EECARApi
            Path: /api/search
            Method: POST

  PartRegistrationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/dist/functions/part-registration/
      Handler: index.handler
      Description: Register new parts and generate embeddings
      MemorySize: 1024  # Higher memory for embedding generation
      Timeout: 60  # Longer timeout for AI processing
      Layers:
        - !Ref EECARUtilsLayer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PartsTable
        - S3CrudPolicy:
            BucketName: !Ref VectorsBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: 'arn:aws:bedrock:ap-northeast-2::foundation-model/*'
            - Effect: Allow
              Action:
                - lambda:InvokeFunction
              Resource: '*'
      Environment:
        Variables:
          COMPLIANCE_FUNCTION_NAME: !Ref ComplianceCheckFunction
      Events:
        RegisterPart:
          Type: Api
          Properties:
            RestApiId: !Ref EECARApi
            Path: /api/parts
            Method: POST

  ComplianceCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/dist/functions/compliance-check/
      Handler: index.handler
      Description: Validate parts against compliance rules (invoked by part registration)
      Layers:
        - !Ref EECARUtilsLayer
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref DocumentsBucket
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationTopic.TopicName
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: 'arn:aws:bedrock:ap-northeast-2::foundation-model/*'

  GetPartsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/dist/functions/get-parts/
      Handler: index.handler
      Description: Retrieve parts information
      Layers:
        - !Ref EECARUtilsLayer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref PartsTable
      Events:
        GetPart:
          Type: Api
          Properties:
            RestApiId: !Ref EECARApi
            Path: /api/parts/{id}
            Method: GET
        ListParts:
          Type: Api
          Properties:
            RestApiId: !Ref EECARApi
            Path: /api/parts
            Method: GET

  WatchPartFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/dist/functions/watch-part/
      Handler: index.handler
      Description: Register alerts for desired parts
      Layers:
        - !Ref EECARUtilsLayer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PartsTable
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationTopic.TopicName
      Events:
        CreateWatch:
          Type: Api
          Properties:
            RestApiId: !Ref EECARApi
            Path: /api/watch
            Method: POST

  ProposalFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/dist/functions/proposal/
      Handler: index.handler
      Description: Handle B2B contract proposals
      Layers:
        - !Ref EECARUtilsLayer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PartsTable
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationTopic.TopicName
      Events:
        CreateProposal:
          Type: Api
          Properties:
            RestApiId: !Ref EECARApi
            Path: /api/proposals
            Method: POST
        GetProposals:
          Type: Api
          Properties:
            RestApiId: !Ref EECARApi
            Path: /api/proposals
            Method: GET

  SyntheticDataFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/dist/functions/synthetic-data/
      Handler: index.handler
      Description: Generate synthetic part data using MCP-style tools
      MemorySize: 1024
      Timeout: 120  # Longer for bulk generation
      Layers:
        - !Ref EECARUtilsLayer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PartsTable
        - S3CrudPolicy:
            BucketName: !Ref VectorsBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: 'arn:aws:bedrock:ap-northeast-2::foundation-model/*'
            # S3 Vectors permissions for synthetic data upload
            - Effect: Allow
              Action:
                - s3vectors:PutVectors
              Resource:
                - 'arn:aws:s3vectors:ap-northeast-2:425454508084:bucket/eecar-vectors-index-12234628'
                - 'arn:aws:s3vectors:ap-northeast-2:425454508084:bucket/eecar-vectors-index-12234628/index/parts-vectors'
      Events:
        GenerateData:
          Type: Api
          Properties:
            RestApiId: !Ref EECARApi
            Path: /api/synthetic
            Method: POST

  BatteryHealthAssessmentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/dist/functions/battery-health-assessment/
      Handler: index.handler
      Description: Battery SOH-based advanced search with reuse/recycle assessment
      Layers:
        - !Ref EECARUtilsLayer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref PartsTable
      Events:
        BatteryHealth:
          Type: Api
          Properties:
            RestApiId: !Ref EECARApi
            Path: /api/battery-health
            Method: POST

  MaterialPropertySearchFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/dist/functions/material-property-search/
      Handler: index.handler
      Description: Material property-based search for aluminum alloys and specifications
      Layers:
        - !Ref EECARUtilsLayer
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref PartsTable
      Events:
        MaterialSearch:
          Type: Api
          Properties:
            RestApiId: !Ref EECARApi
            Path: /api/material-search
            Method: POST

  ContactInquiryFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/dist/functions/contact-inquiry/
      Handler: index.handler
      Description: Handle general contact inquiries and send notifications via SNS
      Layers:
        - !Ref EECARUtilsLayer
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - sns:Publish
              Resource: !Ref NotificationTopic
      Events:
        ContactInquiry:
          Type: Api
          Properties:
            RestApiId: !Ref EECARApi
            Path: /api/contact
            Method: POST

  SlackNotificationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/dist/functions/slack-notification/
      Handler: index.handler
      Description: Send Lambda errors to Slack via CloudWatch Logs Subscription
      MemorySize: 256
      Timeout: 10
      Layers:
        - !Ref EECARUtilsLayer
      Environment:
        Variables:
          SLACK_WEBHOOK_SSM_PARAM: /eecar/slack/webhook-url
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PartsTable
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/eecar/slack/webhook-url'
        - Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: '*'

  # 자동이 2.0: AI DevOps 어시스턴트 (Slack Bot + ReAct Agent)
  SlackAgentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend/dist/functions/slack-agent/
      Handler: index.handler
      Description: 자동이 2.0 - AI DevOps 어시스턴트 (Slash Commands, @멘션, 에러 분석)
      MemorySize: 1024  # AI 처리용 증설
      Timeout: 60  # ReAct 루프용 (Slack은 3초 내 응답 필요, 비동기 처리)
      Layers:
        - !Ref EECARUtilsLayer
      Environment:
        Variables:
          SLACK_BOT_TOKEN_SSM_PARAM: /eecar/slack/bot-token
          SLACK_SIGNING_SECRET_SSM_PARAM: /eecar/slack/signing-secret
          BEDROCK_KB_ID_SSM_PARAM: /eecar/bedrock/kb-id
          S3_VECTORS_BUCKET: eecar-vectors-index-12234628
          S3_VECTORS_MEMORY_INDEX: jadong-memories
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PartsTable
        # SSM: Slack Bot Token, Signing Secret, Bedrock KB ID
        - Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/eecar/slack/bot-token'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/eecar/slack/signing-secret'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/eecar/bedrock/kb-id'
        # CloudWatch Logs: 에러 로그 조회
        - Statement:
            - Effect: Allow
              Action:
                - logs:DescribeLogGroups
                - logs:DescribeLogStreams
                - logs:GetLogEvents
                - logs:FilterLogEvents
                - logs:StartQuery
                - logs:GetQueryResults
              Resource: '*'
        # CloudWatch Metrics: Lambda 상태 조회
        - Statement:
            - Effect: Allow
              Action:
                - cloudwatch:GetMetricData
                - cloudwatch:GetMetricStatistics
                - cloudwatch:ListMetrics
              Resource: '*'
        # Bedrock: Claude (분석), Titan (임베딩)
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: 'arn:aws:bedrock:ap-northeast-2::foundation-model/*'
        # S3 Vectors: jadong-memories (장기 기억)
        - Statement:
            - Effect: Allow
              Action:
                - s3vectors:QueryVectors
                - s3vectors:GetVectors
                - s3vectors:PutVectors
                - s3vectors:DeleteVectors
              Resource:
                - 'arn:aws:s3vectors:ap-northeast-2:425454508084:bucket/eecar-vectors-index-12234628'
                - 'arn:aws:s3vectors:ap-northeast-2:425454508084:bucket/eecar-vectors-index-12234628/index/jadong-memories'
                - 'arn:aws:s3vectors:ap-northeast-2:425454508084:bucket/eecar-vectors-index-12234628/index/parts-vectors'
                - 'arn:aws:s3vectors:ap-northeast-2:425454508084:bucket/eecar-vectors-index-12234628/index/eecar-codebase'
        # Bedrock KB: 코드베이스 검색 (Phase 3)
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:Retrieve
                - bedrock:RetrieveAndGenerate
              Resource: !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/*'
      Events:
        SlackEvents:
          Type: Api
          Properties:
            RestApiId: !Ref EECARApi
            Path: /api/slack/events
            Method: POST

  # DynamoDB Table (Single-table design for cost optimization)
  PartsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: eecar-parts-table
      BillingMode: PAY_PER_REQUEST  # On-demand pricing for low traffic
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false  # Cost optimization

  # S3 Buckets
  VectorsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'eecar-vectors-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 30
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  DocumentsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'eecar-documents-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # SNS Topic for Notifications
  NotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: eecar-notifications
      DisplayName: EECAR Platform Notifications

  # Email Subscription for Notifications
  NotificationEmailSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: email
      TopicArn: !Ref NotificationTopic
      Endpoint: inha2025vip@gmail.com

  # CloudWatch Log Groups (with retention for cost control)
  VectorSearchLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${VectorSearchFunction}'
      RetentionInDays: 7  # Cost optimization: short retention

  PartRegistrationLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${PartRegistrationFunction}'
      RetentionInDays: 7

  ComplianceCheckLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ComplianceCheckFunction}'
      RetentionInDays: 7

  SlackNotificationLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${SlackNotificationFunction}'
      RetentionInDays: 7

  # Note: Other Log Groups already exist (auto-created by Lambda)
  # GetParts, WatchPart, Proposal, SyntheticData, BatteryHealth, MaterialProperty, ContactInquiry

  # Lambda Invoke Permissions for CloudWatch Logs (Must be created before Subscription Filters)
  SlackNotificationInvokePermissionVectorSearch:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SlackNotificationFunction
      Action: lambda:InvokeFunction
      Principal: logs.amazonaws.com
      SourceArn: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${VectorSearchFunction}:*'

  SlackNotificationInvokePermissionPartRegistration:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SlackNotificationFunction
      Action: lambda:InvokeFunction
      Principal: logs.amazonaws.com
      SourceArn: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${PartRegistrationFunction}:*'

  SlackNotificationInvokePermissionComplianceCheck:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SlackNotificationFunction
      Action: lambda:InvokeFunction
      Principal: logs.amazonaws.com
      SourceArn: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${ComplianceCheckFunction}:*'

  SlackNotificationInvokePermissionGetParts:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SlackNotificationFunction
      Action: lambda:InvokeFunction
      Principal: logs.amazonaws.com
      SourceArn: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${GetPartsFunction}:*'

  SlackNotificationInvokePermissionWatchPart:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SlackNotificationFunction
      Action: lambda:InvokeFunction
      Principal: logs.amazonaws.com
      SourceArn: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${WatchPartFunction}:*'

  SlackNotificationInvokePermissionProposal:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SlackNotificationFunction
      Action: lambda:InvokeFunction
      Principal: logs.amazonaws.com
      SourceArn: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${ProposalFunction}:*'

  SlackNotificationInvokePermissionSyntheticData:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SlackNotificationFunction
      Action: lambda:InvokeFunction
      Principal: logs.amazonaws.com
      SourceArn: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${SyntheticDataFunction}:*'

  SlackNotificationInvokePermissionBatteryHealth:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SlackNotificationFunction
      Action: lambda:InvokeFunction
      Principal: logs.amazonaws.com
      SourceArn: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${BatteryHealthAssessmentFunction}:*'

  SlackNotificationInvokePermissionMaterialProperty:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SlackNotificationFunction
      Action: lambda:InvokeFunction
      Principal: logs.amazonaws.com
      SourceArn: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${MaterialPropertySearchFunction}:*'

  SlackNotificationInvokePermissionContactInquiry:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SlackNotificationFunction
      Action: lambda:InvokeFunction
      Principal: logs.amazonaws.com
      SourceArn: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${ContactInquiryFunction}:*'

  # CloudWatch Logs Subscription Filters (Depend on Permissions)
  VectorSearchLogSubscription:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn:
      - VectorSearchLogGroup
      - SlackNotificationFunction
      - SlackNotificationInvokePermissionVectorSearch
    Properties:
      LogGroupName: !Sub '/aws/lambda/${VectorSearchFunction}'
      FilterPattern: '?ERROR ?Exception ?Timeout ?"Task timed out"'
      DestinationArn: !GetAtt SlackNotificationFunction.Arn

  PartRegistrationLogSubscription:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn:
      - PartRegistrationLogGroup
      - SlackNotificationFunction
      - SlackNotificationInvokePermissionPartRegistration
    Properties:
      LogGroupName: !Sub '/aws/lambda/${PartRegistrationFunction}'
      FilterPattern: '?ERROR ?Exception ?Timeout ?"Task timed out"'
      DestinationArn: !GetAtt SlackNotificationFunction.Arn

  ComplianceCheckLogSubscription:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn:
      - ComplianceCheckLogGroup
      - SlackNotificationFunction
      - SlackNotificationInvokePermissionComplianceCheck
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ComplianceCheckFunction}'
      FilterPattern: '?ERROR ?Exception ?Timeout ?"Task timed out"'
      DestinationArn: !GetAtt SlackNotificationFunction.Arn

  GetPartsLogSubscription:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn:
      - SlackNotificationFunction
      - SlackNotificationInvokePermissionGetParts
    Properties:
      LogGroupName: !Sub '/aws/lambda/${GetPartsFunction}'
      FilterPattern: '?ERROR ?Exception ?Timeout ?"Task timed out"'
      DestinationArn: !GetAtt SlackNotificationFunction.Arn

  WatchPartLogSubscription:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn:
      - SlackNotificationFunction
      - SlackNotificationInvokePermissionWatchPart
    Properties:
      LogGroupName: !Sub '/aws/lambda/${WatchPartFunction}'
      FilterPattern: '?ERROR ?Exception ?Timeout ?"Task timed out"'
      DestinationArn: !GetAtt SlackNotificationFunction.Arn

  ProposalLogSubscription:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn:
      - SlackNotificationFunction
      - SlackNotificationInvokePermissionProposal
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProposalFunction}'
      FilterPattern: '?ERROR ?Exception ?Timeout ?"Task timed out"'
      DestinationArn: !GetAtt SlackNotificationFunction.Arn

  SyntheticDataLogSubscription:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn:
      - SlackNotificationFunction
      - SlackNotificationInvokePermissionSyntheticData
    Properties:
      LogGroupName: !Sub '/aws/lambda/${SyntheticDataFunction}'
      FilterPattern: '?ERROR ?Exception ?Timeout ?"Task timed out"'
      DestinationArn: !GetAtt SlackNotificationFunction.Arn

  BatteryHealthLogSubscription:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn:
      - SlackNotificationFunction
      - SlackNotificationInvokePermissionBatteryHealth
    Properties:
      LogGroupName: !Sub '/aws/lambda/${BatteryHealthAssessmentFunction}'
      FilterPattern: '?ERROR ?Exception ?Timeout ?"Task timed out"'
      DestinationArn: !GetAtt SlackNotificationFunction.Arn

  MaterialPropertyLogSubscription:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn:
      - SlackNotificationFunction
      - SlackNotificationInvokePermissionMaterialProperty
    Properties:
      LogGroupName: !Sub '/aws/lambda/${MaterialPropertySearchFunction}'
      FilterPattern: '?ERROR ?Exception ?Timeout ?"Task timed out"'
      DestinationArn: !GetAtt SlackNotificationFunction.Arn

  ContactInquiryLogSubscription:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn:
      - SlackNotificationFunction
      - SlackNotificationInvokePermissionContactInquiry
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ContactInquiryFunction}'
      FilterPattern: '?ERROR ?Exception ?Timeout ?"Task timed out"'
      DestinationArn: !GetAtt SlackNotificationFunction.Arn

  # CloudWatch Dashboard for monitoring
  EECARDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: eecar-monitoring
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Lambda Invocations & Errors",
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${VectorSearchFunction}", {"label": "VectorSearch"}],
                  ["...", "${PartRegistrationFunction}", {"label": "PartRegistration"}],
                  ["...", "${GetPartsFunction}", {"label": "GetParts"}],
                  ["AWS/Lambda", "Errors", "FunctionName", "${VectorSearchFunction}", {"label": "VectorSearch Errors", "color": "#d62728"}],
                  ["...", "${PartRegistrationFunction}", {"label": "PartRegistration Errors", "color": "#ff7f0e"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Lambda Duration (ms)",
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "${VectorSearchFunction}", {"label": "VectorSearch"}],
                  ["...", "${PartRegistrationFunction}", {"label": "PartRegistration"}],
                  ["...", "${GetPartsFunction}", {"label": "GetParts"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "API Gateway Requests",
                "metrics": [
                  ["AWS/ApiGateway", "Count", "ApiName", "eecar-api", {"label": "Total Requests"}],
                  [".", "4XXError", ".", ".", {"label": "4XX Errors", "color": "#ff7f0e"}],
                  [".", "5XXError", ".", ".", {"label": "5XX Errors", "color": "#d62728"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "API Gateway Latency (ms)",
                "metrics": [
                  ["AWS/ApiGateway", "Latency", "ApiName", "eecar-api", {"label": "Latency"}],
                  [".", "IntegrationLatency", ".", ".", {"label": "Integration Latency"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "DynamoDB Capacity Units",
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedReadCapacityUnits", "TableName", "${PartsTable}", {"label": "Read CU"}],
                  [".", "ConsumedWriteCapacityUnits", ".", ".", {"label": "Write CU"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "DynamoDB Throttles & Errors",
                "metrics": [
                  ["AWS/DynamoDB", "ReadThrottledRequests", "TableName", "${PartsTable}", {"label": "Read Throttled"}],
                  [".", "WriteThrottledRequests", ".", ".", {"label": "Write Throttled"}],
                  [".", "UserErrors", ".", ".", {"label": "User Errors", "color": "#d62728"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}"
              }
            }
          ]
        }

Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub 'https://${EECARApi}.execute-api.${AWS::Region}.amazonaws.com/prod'
    Export:
      Name: !Sub '${AWS::StackName}-ApiEndpoint'

  PartsTableName:
    Description: DynamoDB table name
    Value: !Ref PartsTable
    Export:
      Name: !Sub '${AWS::StackName}-PartsTable'

  VectorsBucketName:
    Description: S3 bucket for vector embeddings
    Value: !Ref VectorsBucket
    Export:
      Name: !Sub '${AWS::StackName}-VectorsBucket'

  DocumentsBucketName:
    Description: S3 bucket for compliance documents
    Value: !Ref DocumentsBucket
    Export:
      Name: !Sub '${AWS::StackName}-DocumentsBucket'

  NotificationTopicArn:
    Description: SNS topic ARN for notifications
    Value: !Ref NotificationTopic
    Export:
      Name: !Sub '${AWS::StackName}-NotificationTopic'

  XRayServiceMap:
    Description: X-Ray Service Map URL
    Value: !Sub 'https://console.aws.amazon.com/xray/home?region=${AWS::Region}#/service-map'

  CloudWatchDashboard:
    Description: CloudWatch Dashboard URL
    Value: !Sub 'https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=eecar-monitoring'
